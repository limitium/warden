version: '3'
services:
   nginx:
      image: budry/jwilder-nginx-proxy-arm
      restart: always
      ports:
        - '80:80'
      depends_on:
        - mqtt2prom
        - prom
        - graf
      volumes:
         - '/var/run/docker.sock:/tmp/docker.sock:ro'
   mqtt2prom:
     image: limitium/mqtt2prom
     expose:
       - '9344'
     volumes:
       - ./mqtt2prom/provisioning:/usr/src/app/conf:ro
     environment:
       VIRTUAL_HOST: mqtt2prom.lvh.me
   prom:
      image: 'prom/prometheus:latest'
      restart: always
      command:
         - '--config.file=/etc/prometheus/prometheus.yml'
         - '--storage.tsdb.path=/prometheus'
         - '--web.console.libraries=/etc/prometheus/console_libraries'
         - '--web.console.templates=/etc/prometheus/consoles'
         - '--storage.tsdb.retention.time=100d'
         - '--storage.tsdb.retention.size=20GB'
      expose:
         - '9090'
      volumes: 
        - ./prom/provisioning:/etc/prometheus:ro
        - ./prom/data:/prometheus:rw
      environment:
         VIRTUAL_HOST: prom.lvh.me
   graf:
      image: 'grafana/grafana:7.1.2'
      restart: always
      ports:
         - '3000:3000'
      expose:
         - '3000'
      volumes:
         - ./graf/provisioning:/etc/grafana/provisioning:ro
         - ./graf/data:/var/lib/grafana:rw
      environment:
         VIRTUAL_HOST: graf.limitium.art
